{"version":3,"file":"visit-all.js","sources":["../../src/routing/visit-all.ts"],"sourcesContent":["import { assert as debugAssert } from '@ember/debug';\nimport {\n  visit,\n  find,\n  getContext,\n  click,\n  currentURL,\n  findAll,\n} from '@ember/test-helpers';\nimport QUnit from 'qunit';\nimport type Owner from '@ember/owner';\nimport type RouterService from '@ember/routing/router-service';\n\ninterface InAppLink {\n  href: string;\n  original: string;\n  selector: string;\n}\n\nfunction findInAppLinks(): InAppLink[] {\n  const results: InAppLink[] = [];\n\n  const allAnchorsOnThePage = findAll('a');\n\n  for (const a of allAnchorsOnThePage) {\n    const href = a.getAttribute('href');\n\n    if (!href) continue;\n    if (href.startsWith('http')) continue;\n\n    const current = new URL(currentURL(), window.location.origin);\n    const url = new URL(href, current);\n    const withoutDomain = `${url.pathname}${url.search}${url.hash}`;\n\n    results.push({\n      href: withoutDomain,\n      original: href,\n      selector: `a[href=\"${href}\"]`,\n    });\n  }\n\n  return results;\n}\n\nconst assert = QUnit.assert;\n\nexport async function visitAllLinks(\n  callback?: (url: string) => void | Promise<void>,\n  knownRedirects?: Record<string, string>,\n) {\n  /**\n   * string of \"on::target\"\n   */\n  const visited = new Set();\n  let returnTo = '/';\n\n  await visit(returnTo);\n\n  const inAppLinks = findInAppLinks();\n  const queue: (InAppLink | { changeReturnTo: string })[] = [...inAppLinks];\n\n  const ctx = getContext() as unknown as { owner: Owner };\n  const router = ctx?.owner?.lookup('service:router') as RouterService;\n\n  debugAssert(`Could not find the router service`, router);\n\n  const rootURL = router.rootURL;\n\n  while (queue.length > 0) {\n    const toVisit = queue.shift();\n\n    debugAssert(`Queue entries cannot be falsey`, toVisit);\n\n    if ('changeReturnTo' in toVisit) {\n      returnTo = toVisit.changeReturnTo;\n      continue;\n    }\n\n    // In-page links are on the page we're already on.\n    // As long as we haven't already encountered an error,\n    // this is silly to check.\n    if (toVisit.original.startsWith('#')) {\n      continue;\n    }\n\n    const [nonHashPart] = toVisit.href.split('#');\n\n    // This was our first page, we've already been here\n    if (nonHashPart === '/') {\n      continue;\n    }\n\n    const key = `${currentURL()}::${nonHashPart}`;\n\n    if (visited.has(key)) continue;\n\n    const result = router.recognize(toVisit.href);\n\n    if (!result) {\n      assert.ok(\n        true,\n        `${toVisit.href} on page ${returnTo} is not recognized by this app and will be skipped`,\n      );\n      continue;\n    }\n\n    await visit(returnTo);\n\n    const link = find(toVisit.selector);\n\n    debugAssert(`link exists via selector \\`${toVisit.selector}\\``, link);\n\n    await click(link);\n\n    const current =\n      rootURL.replace(/\\/$/, '') + '/' + currentURL().replace(/^\\//, '');\n    const expected = knownRedirects?.[toVisit.href] ?? toVisit.href;\n\n    assert.pushResult({\n      result: current.startsWith(expected),\n      actual: current,\n      expected: expected,\n      message: `Navigation was successful: to:${toVisit.original}, from:${returnTo}`,\n    });\n    visited.add(key);\n\n    if (callback) {\n      await callback(toVisit.href);\n    }\n\n    const links = findInAppLinks();\n\n    queue.push({ changeReturnTo: currentURL() });\n    queue.push(...links);\n  }\n\n  return visited.size;\n}\n"],"names":["findInAppLinks","results","allAnchorsOnThePage","findAll","a","href","getAttribute","startsWith","current","URL","currentURL","window","location","origin","url","withoutDomain","pathname","search","hash","push","original","selector","assert","QUnit","visitAllLinks","callback","knownRedirects","visited","Set","returnTo","visit","inAppLinks","queue","ctx","getContext","router","owner","lookup","debugAssert","rootURL","length","toVisit","shift","changeReturnTo","nonHashPart","split","key","has","result","recognize","ok","link","find","click","replace","expected","pushResult","actual","message","add","links","size"],"mappings":"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"}