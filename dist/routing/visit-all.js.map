{"version":3,"file":"visit-all.js","sources":["../../src/routing/visit-all.ts"],"sourcesContent":["import { assert as debugAssert } from '@ember/debug';\nimport {\n  visit,\n  find,\n  getContext,\n  click,\n  currentURL,\n  findAll,\n} from '@ember/test-helpers';\nimport QUnit from 'qunit';\nimport type Owner from '@ember/owner';\nimport type RouterService from '@ember/routing/router-service';\n\ninterface InAppLink {\n  href: string;\n  original: string;\n  selector: string;\n}\n\nfunction findInAppLinks(): InAppLink[] {\n  const results: InAppLink[] = [];\n\n  const allAnchorsOnThePage = findAll('a');\n\n  for (const a of allAnchorsOnThePage) {\n    const href = a.getAttribute('href');\n\n    if (!href) continue;\n    if (href.startsWith('http')) continue;\n\n    const current = new URL(currentURL(), window.location.origin);\n    const url = new URL(href, current);\n    const withoutDomain = `${url.pathname}${url.search}${url.hash}`;\n\n    results.push({\n      href: withoutDomain,\n      original: href,\n      selector: `a[href=\"${href}\"]`,\n    });\n  }\n\n  return results;\n}\n\nconst assert = QUnit.assert;\n\nexport async function visitAllLinks(\n  callback?: (url: string) => void | Promise<void>,\n) {\n  /**\n   * string of \"on::target\"\n   */\n  const visited = new Set();\n  let returnTo = '/';\n\n  await visit(returnTo);\n\n  const inAppLinks = findInAppLinks();\n  const queue: (InAppLink | { changeReturnTo: string })[] = [...inAppLinks];\n\n  const ctx = getContext() as unknown as { owner: Owner };\n  const router = ctx?.owner?.lookup('service:router') as RouterService;\n\n  debugAssert(`Could not find the router service`, router);\n\n  while (queue.length > 0) {\n    const toVisit = queue.shift();\n\n    debugAssert(`Queue entries cannot be falsey`, toVisit);\n\n    if ('changeReturnTo' in toVisit) {\n      returnTo = toVisit.changeReturnTo;\n      continue;\n    }\n\n    // In-page links are on the page we're already on.\n    // As long as we haven't already encountered an error,\n    // this is silly to check.\n    if (toVisit.original.startsWith('#')) {\n      continue;\n    }\n\n    const [nonHashPart] = toVisit.href.split('#');\n\n    // This was our first page, we've already been here\n    if (nonHashPart === '/') {\n      continue;\n    }\n\n    const key = `${currentURL()}::${nonHashPart}`;\n\n    if (visited.has(key)) continue;\n\n    const result = router.recognize(toVisit.href);\n\n    if (!result) {\n      assert.ok(\n        true,\n        `${toVisit.href} on page ${returnTo} is not recognized by this app and will be skipped`,\n      );\n      continue;\n    }\n\n    await visit(returnTo);\n\n    const link = find(toVisit.selector);\n\n    debugAssert(`link exists via selector \\`${toVisit.selector}\\``, link);\n\n    await click(link);\n    assert.pushResult({\n      result: currentURL().startsWith(toVisit.href),\n      actual: currentURL(),\n      expected: toVisit.href,\n      message: `Navigation was successful: to:${toVisit.original}, from:${returnTo}`,\n    });\n    visited.add(key);\n\n    if (callback) {\n      await callback(toVisit.href);\n    }\n\n    const links = findInAppLinks();\n\n    queue.push({ changeReturnTo: currentURL() });\n    queue.push(...links);\n  }\n\n  return visited.size;\n}\n"],"names":["findInAppLinks","results","allAnchorsOnThePage","findAll","a","href","getAttribute","startsWith","current","URL","currentURL","window","location","origin","url","withoutDomain","pathname","search","hash","push","original","selector","assert","QUnit","visitAllLinks","callback","visited","Set","returnTo","visit","inAppLinks","queue","ctx","getContext","router","owner","lookup","debugAssert","length","toVisit","shift","changeReturnTo","nonHashPart","split","key","has","result","recognize","ok","link","find","click","pushResult","actual","expected","message","add","links","size"],"mappings":"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"}